var initItiebaMessage;!new function(){TbICom.call(this);var e,t,i,s,a,n="",r=[],o=0,l=[],p={atme:0,light:0,reply:0,favts:0,recycle:0},c="default",u=!1,d={all_msg:{id:0,display:!0,aside_tip_id:"",url:""},fans:{id:1,url:"#itb_home#&type=fans",aside_tip_id:"",display:!1},____prop_out_of_date:{id:2,url:"/tbmall/message",aside_tip_id:"tbmall_num_tip",display:!0},scores:{id:3,url:"/tbmall/getTdou",aside_tip_id:"tbmall_num_tip",display:!0},reply:{id:4,url:"#itb_home#&type=replyme",aside_tip_id:"new_reply_num_tip",display:!1},feature:{id:5,url:"#itb_home#&type=feature",aside_tip_id:"new_feature_num_tip",display:!0},guess:{id:6,url:"#itb_home#&type=main",aside_tip_id:"new_guess_num_tip",display:!0},postPasser:{id:8,display:!1},atme:{id:9,url:"#itb_home#&type=atme",aside_tip_id:"new_atme_num_tip",display:!1},recycle:{id:10,url:"/pmc/recycle",aside_tip_id:"new_recycle_num_tip",display:!0},invite:{id:11,url:"#itb_home#",aside_tip_id:"new_invite_num_tip",display:!0},prop_out_of_date:{id:12,url:"/tbmall/message",aside_tip_id:"tbmall_num_tip",display:!0},paperprops:{id:16,url:"http://tieba.baidu.com/tb/zt/tietiao/index.html",aside_tip_id:"new_paperprops_num_tip",display:!0},gameOpen:{id:17,url:"/game/index",aside_tip_id:"new_gameOpen_num_tip",display:!0},lotteryDraw:{id:18,url:"/f?kw=%B2%CA%C6%B1&tab=lc_mylottery#/user/order",aside_tip_id:"new_lotteryDraw_num_tip",display:!0},lotteryAward:{id:19,url:"/f?kw=%B2%CA%C6%B1&tab=lc_mylottery#/user/account",aside_tip_id:"new_lotteryAward_num_tip",display:!0},favts:{id:20,url:"#itb_home#&type=storethread",aside_tip_id:"new_storethread_num_tip",display:!1},meizhiLevelUp:{id:15,url:"#other_url#?type=meizhiLevelUp",aside_tip_id:"new_meizhiLevelUp_tip",display:!0},friendapply:{id:22,url:"#itb_home#&type=friendapply",aside_tip_id:"new_friendapply_num_tip",display:!1}},m={itb_home:""},f=function(e,s){t=e,i=s||$("#com_userbar");var a=TbCom.process("MsgSystem","getIsReady");a?y():TbCom.addEvent("MsgSystem","ready",function(){y(),TbCom.trigger&&TbCom.trigger("msgsystem_ready")})},y=function(){if(!u){"itieba"!=t&&(n="_blank");var e=TbCom.process("User","getUserInfo");e&&e.is_login&&e.portrait?g(e):TbCom.process("User","getUserInfoByRequest",g),u=!0}},g=function(t){e=t.portrait,m.itb_home="/i/sys/jump?u="+e;for(var i in d)r[d[i].id]=i;for(var s in d){var a=d[s];if("undefined"!=typeof a.url)switch(s){case"guess":d[s].url=a.url.replace(/#itb_home#/g,"/i/app/"+s+"?uc="+e);break;case"invite":d[s].url=a.url.replace(/#itb_home#/g,"/f/i/invite");break;case"meizhiLevelUp":d[s].url=a.url.replace(/#other_url#/g,"/encourage/get/meizhi/jump");break;default:d[s].url=a.url.replace(/#itb_home#/g,"/i/sys/jump?u="+e)}}b(),h();var n=this;TbCom.addEvent("MsgSystem","sys_message",function(){j.apply(n,arguments),TbCom.trigger&&TbCom.trigger("msgsystem_message",arguments)}),TbCom.addEvent("MsgSystem","listenComplete",function(){A.apply(n,arguments),TbCom.trigger&&TbCom.trigger("msgsystem_listencomplete",arguments)}),w()},b=function(){var e=r,t=[];t.push('<div class="allMsg" style="clear:both;"><ul>');for(var n=0,o=e.length;o>n;n++)t.push('<li id="message_'+e[n]+'" style="display:none;"></li>');t.push("</ul>"),t.push('<div class="tb_msg_tip_rightpanel">'),t.push('<a href="'+m.itb_home+'&type=profile#notify" style="height:100%;" target="_self" class="setting">\u8BBE\u7F6E</a>'),t.push('<a title="\u5173\u95ED" href="#" onclick="return false;" class="close_msg_tip"></a>'),t.push('<b style="clear:both; text-align:left;"></b>'),t.push("</div></div>");var l=$("#com_userbar").find(".u_setting>div"),p=l.offset().left,c=p?p:0,u=$("body").width();_right=u-c-100,_right=_right>350?180:_right;var d={content:t.join(""),arrow_dir:"up",bubble_css:{right:_right,width:170,top:25},arrow_pos:{left:30},level:2,attr:" id='com_userbar_message' ",wrap:i},f=new UiBubbleTipBase(d);f.setFixedForMessage(),s=f.j_bubble,a=f,$("#mobile_promote_download").bind("click",function(){_.Module.use("common/component/diversionDialog",[],function(e){e.showDiversionDialog("webtbnews")})})},h=function(){$("body").on("click",".close_msg_tip",function(){return TbCom.process("UserMessage","clearAllData"),$(this).closest(".allMsg").find(".j_clear_notify").each(function(){var e=$(this).getData().type;$.tb.Storage.remove(e)}),!1}),$(window).on("beforeunload",function(){var e=0,t=l.length;for(o=1;t>e;e++)window.Notification?l[e].close():window.webkitNotifications&&l[e].cancel()})},v=function(e){TbCom.process("MsgSystem","doSomethingAfterReady",function(){e()})},w=function(){var t="/messagepool/get_data",i=t+"?user="+e;$.JsLoadManager.use(i)},M=function(e){v(function(){switch(e){case"favts":I();break;default:T(e),U(e)}})},T=function(t){var i=(new Date).getTime(),s=d[t].id;if(20!==s){var a="/messagepool/clear_data?type="+s+"&user="+e+"&stamp="+i,n=new Image;window["itieba_msg_clearer_"+i]=n,n.src=a}},k=function(){v(function(){for(var e in d)"all_msg"!=e&&T(e);N()})},C=function(){},I=function(){},S=function(e){TbCom.trigger&&TbCom.trigger("msgsystem_initall",e);var t=e.join(",");C(),Y(t),TbCom.process("MsgSystem","sendMsg","other","sys","all_msg",t,"default",null,!1)};initItiebaMessage=S;var U=function(e){v(function(){e&&""!=e&&TbCom.process("MsgSystem","sendMsg","all","sys",e,"0","default",null,!1)})},N=function(){TbCom.process("MsgSystem","sendMsg","all","sys","clear_msg","all","default",null,!1),TbCom.process("MsgSystem","removeMsgByMod","sys","command_listen"),I()},D=function(){var e="/f?ct=486539264&cm=59202&tn=jsonUserInfo&t="+Math.random();$.get(e,{},function(e){var t=$.json.decode(e);t.beans_num&&(TbCom.process("MsgSystem","sendMsg","all","sys","wealth",t.beans_num,"default",null,!1),setTimeout(function(){T("wealth"),TbCom.process("MsgSystem","removeMsg","sys","wealth")},100))})},A=function(e,t){for(var i=t.mod,s=0,a=t.msg.length;a>s;s++){var n=r[t.msg[s].type],o=t.msg[s].cnt;if("sys"==i&&"wealth"==n)return D(),void 0;TbCom.process("MsgSystem","sendMsg","all",i,n,o,"default",null,!1)}},j=function(e,t){if(t){var i=t.type,s=t.content;i&&"undefined"!=typeof s?z(i,s):$.console.debug("@UserMessage _renderMsg : \u8FD4\u56DE\u7684\u6570\u636E\u4E2D\u6CA1\u6709type\u548Ccontent")}else $.console.debug("@UserMessage _renderMsg : \u4E0D\u9700\u8981\u5904\u7406\uFF01")},z=function(e,t){switch(e){case"all_msg":Y(t);break;case"fans":B(t);break;case"scores":O(t);break;case"reply":E(t),R();break;case"feature":x(t);break;case"guess":P(t);break;case"atme":Q(t),R();break;case"prop_out_of_date":L(t);break;case"invite":W(t);break;case"paperprops":H(t);case"favts":break;case"friendapply":F(t);break;case"recycle":q(t),R();break;case"clear_msg":X(t);break;case"gameOpen":J(t);break;case"meizhiLevelUp":V(t);break;case"lotteryDraw":G(t);break;case"lotteryAward":K(t);default:$.console.debug("@UserMessage _renderMsgHandler; LCF\u8FD4\u56DE\u7684\u6D88\u606F\u6CA1\u6709\u5904\u7406\u51FD\u6570")}},B=function(e){var t=parseInt(e);t>0?(it("fans",t,"\u65B0\u7C89\u4E1D"),tt("fans",t,"\u65B0\u7C89\u4E1D")):st("fans")},L=function(e){var t=parseInt(e);t>0?(it("prop_out_of_date",t,"T\u8C46\u5546\u57CE\u4FE1\u606F"),tt("prop_out_of_date",t,"T\u8C46\u5546\u57CE\u4FE1\u606F")):st("prop_out_of_date")},O=function(e){var t=parseInt(e);t>0?(it("scores",t,"\u8D60\u900110T\u8C46\u4FE1\u606F"),tt("scores",t,"\u8D60\u900110T\u8C46\u4FE1\u606F")):st("scores")},x=function(e){var t=parseInt(e),i=$("#new_feature_num_tip"),s="";t>0?(it("feature",t,"\u65B0\u7CBE\u54C1"),tt("feature",t,"\u65B0\u7CBE\u54C1"),s="("+e+"\u65B0)"):st("feature"),i&&i.html(s)},E=function(e){var t=parseInt(e);p.reply=t,t>0?(it("reply",t,"\u65B0\u56DE\u590D"),tt("reply",t,"\u65B0\u56DE\u590D")):st("reply")},R=function(){var e=p.reply+p.atme+p.light+p.recycle;if(e>0){var t=$("#new_reply_num_tip"),i="";i="("+e+"\u65B0)",t&&t.html(i)}else var t=$("#new_reply_num_tip").html("")},F=function(e){var t=parseInt(e);if(p.friendapply=t,t>0){var i=$("#new_friendapply_num_tip"),s="";s="("+t+"\u65B0)",i&&i.html(s),it("friendapply",t,"\u65B0\u7684\u597D\u53CB\u7533\u8BF7"),tt("friendapply",t,"\u65B0\u7684\u597D\u53CB\u7533\u8BF7"),$.stats.sendRequest("fr=tb0_forum&st_mod=msgsys&st_type=friendapplyshow")}else st("friendapply")},q=function(e){var t=parseInt(e);p.recycle=t,t>0?(it("recycle",t,"\u56DE\u6536\u7AD9\u63D0\u9192"),tt("recycle",t,"\u56DE\u6536\u7AD9\u63D0\u9192")):st("recycle")},P=function(e){var t=parseInt(e);t>0?(it("guess",t,"\u7ADE\u731C\u7ED3\u679C"),tt("guess",t,"\u7ADE\u731C\u7ED3\u679C")):st("guess")},W=function(e){var t=parseInt(e);p.invite=t,t>0?(it("invite",t,"\u7C89\u4E1D\u798F\u5229\u5361"),tt("invite",t,"\u7C89\u4E1D\u798F\u5229\u5361")):st("invite")},H=function(e){var t=parseInt(e);p.paperprops=t,t>0?(it("paperprops",t,"\u8D34\u6761\u9053\u5177\u4FE1\u606F"),tt("paperprops",t,"\u8D34\u6761\u9053\u5177\u4FE1\u606F")):st("paperprops")},J=function(e){var t=parseInt(e);t>0?(it("gameOpen",t,"\u6E38\u620F\u5F00\u670D\u901A\u77E5"),tt("gameOpen",t,"\u6E38\u620F\u5F00\u670D\u901A\u77E5")):st("gameOpen")},V=function(e){var t=parseInt(e);t>0?(it("meizhiLevelUp",null,"\u59B9\u7EB8\uFF0CMvp\u5347\u7EA7\u4E86\uFF01"),tt("meizhiLevelUp",null,"\u59B9\u7EB8\uFF0CMvp\u5347\u7EA7\u4E86\uFF01")):st("meizhiVote")},G=function(e){var t=parseInt(e);t>0?(it("lotteryDraw",t,"\u5F69\u7968\u5F00\u5956\u63D0\u9192"),tt("lotteryDraw",t,"\u5F69\u7968\u5F00\u5956\u63D0\u9192")):st("lotteryDraw")},K=function(e){var t=parseInt(e);t>0?(it("lotteryAward",t,"\u5F69\u7968\u4E2D\u5956\u63D0\u9192"),tt("lotteryAward",t,"\u5F69\u7968\u4E2D\u5956\u63D0\u9192")):st("lotteryAward")},Q=function(e){var t=parseInt(e);p.atme=t,t>0?(it("atme",t,"@\u63D0\u5230\u6211"),tt("atme",t,"@\u63D0\u5230\u6211")):st("atme")},X=function(){for(var e=s,t=e.find("li"),i=0,a=t.length;a>i;i++)$(t[i]).css("display","none");e.css("display","none");var n=null,r="";for(var o in d)r=d[o].aside_tip_id,"string"==typeof r&&""!=r&&(n=$("#"+r),n&&(n.html(""),n.css("display","none")))},Y=function(e){for(var t,i=e.split(","),s=r,a=s.length-1,n=0,o=i.length;o>n;n++)num=i[n],a>n&&(t=s[n+1],z(t,num))},Z=function(e){c=e},et=function(){return window.Notification&&"granted"==window.Notification.permission||window.webkitNotifications&&0==window.webkitNotifications.checkPermission()},tt=function(e,t,i){var s=function(e,t,i){et()&&(this.notify=null,this.init(e,t,i))};return s.conf={title:"\u8D34\u5427\u6D88\u606F\u901A\u77E5",icon:{}},s.prototype={constructor:s,init:function(e,t,i){var a=s.conf.title,n="/tb/static-common/img/notify/"+e+".png",r="\u60A8\u6709"+t+"\u4E2A"+i,o=d[e].url;$.tb.Storage.get(e)!=t&&(this.createNotify(a,n,r,e),this.setEvent(e,t,o),l.push(this.notify),$.tb.Storage.set(e,t))},createNotify:function(e,t,i,s){var a=null;(a=window.Notification)?this.notify=new Notification(e,{icon:t,body:i,tag:s}):(a=window.webkitNotifications)&&(this.notify=a.createNotification(t,e,i),this.notify.replaceId=s,this.notify.show())},closeNotify:function(e){window.Notification?e.currentTarget&&e.currentTarget.close():window.webkitNotifications&&e.currentTarget.cancel()},setEvent:function(e,t,i){var s=this,a=s.notify,n=0;a.ondisplay=function(e){var t=setTimeout(function(){n=1,s.closeNotify(e),clearTimeout(t)},2e4)},a.onshow=function(e){var t=20;$.browser.mozilla&&(t=3);var i=setTimeout(function(){n=1,s.closeNotify(e),clearTimeout(i)},1e3*t)},a.onclick=function(e){s.closeNotify(e),window.open(i)},a.onclose=function(){1!=n&&1!=o&&(M(e),$.tb.Storage.remove(e))},a.onerror=function(){}}},new s(e,t,i)},it=function(e,t,i){var s=$("#message_"+e)||null,r=d[e];if(0!=r.display&&s){var o=(r.id,r.url),l=$("<span>"+t+"\u4E2A</span>"),p=$('<a class="j_clear_notify">'+i+"</a>").bindData({type:e});p.tbattr({href:o,target:n}),p.bind("click",function(){M(e),$.tb.Storage.remove(e),$.stats.track((e||"")+"_click","user_message")}),s.html(""),null!==t&&s.append(l),s.append(p),s.css("display","block"),a&&a.showBubble(),$("#u_xiangce").find(".j_wrap").hide()}},st=function(e){var t=$("#message_"+e),i=s,a=i.find("li");t.css("display","none");for(var n=!0,r=0,o=a.length;o>r;r++)if("none"!=$(a[r]).css("display")){n=!1;break}i.css("display",n?"none":"block")},at=function(e,t){e&&e in d&&(d[e].display=!!t)};this.initSys("UserMessage",["User","MsgSystem","WealthSystem"],{init:f,clearSysMsg:U,clearData:M,clearAllData:k,setWealthActionType:Z,setMsgDisplay:at})};